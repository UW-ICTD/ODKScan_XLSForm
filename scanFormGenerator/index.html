<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Form View</title>
    <meta name="viewport" content="width=device-width, initial-scale=.3">
    <meta name="author" content="Nathan Breit">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="assets/css/docs.css" rel="stylesheet">
    <link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">
    <link href="formDrawer.css" rel="stylesheet">
    <style>
    body {
        margin: 0;
        font-size: 15pt;
        font-family: "Times New Roman"; 
        padding-top: 0;
    	min-width: 832px;
    }
    
    .image-container {
        margin-left: auto;
    	margin-right: auto;
    	padding: 0;
    	width: 832px;
    }
    
    .modal-gallery {
    	width: auto;
    	max-height: none;
    	margin: 2em;
    	top: 0;
    	left: 0;
    	position: relative;
    	float: left;
    }
    .modal-gallery .modal-body {
    	max-height: none;
    }
    .instructions {
        color:white;
        font-size: 2em;
        line-height: 2.1em;
    }
    /*
    canvas {
        position: absolute;
    	z-index: 400;
    }
    */


    
    #drop {
        background-color: white;
        border:2px dashed #bbb;
        -moz-border-radius:5px;
        -webkit-border-radius:5px;
        border-radius:5px;
        padding:25px;
        text-align:center;
    	font:20pt bold;
        color:#bbb
    }
    #out {
        clear: both;
        height: 500px;
        width: 100%;
    }
    #save {
        float: right;
        font-size: 15pt;
        margin-top: 15px;
        font-family: "Times New Roman"; 
    }
    #errors p {
        background-color: pink;
        margin-top: 1em;
        margin-bottom: 1em;
        padding: .5em;
    }
    #warnings p {
        background-color: orange;
        margin-top: 1em;
        margin-bottom: 1em;
        padding: .5em;
    }
    .panel {
        background-color: #f5f5f5;
        border: 1px solid lightgray;
        padding: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
    }
    @media print {
        .main { display: none; }
    }
    </style>
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

    <body data-spy="scroll" data-target=".subnav" data-offset="50" style="background-color:black;">

    
        <div class="main">
        
            <div class="panel">
                <div id="drop">Drop an XLSX file here to generate a new form</div>
            </div>
            
            <div id="errors"></div>
            <div id="warnings"></div>
            
            <img class="outImg"></img>
            <div class="fContainer">
                <div class="formImage">
                    <img class="tl fiducial" src="fiducials/ScanLogoSm.png">
                    <img class="tr fiducial" src="fiducials/villagereach.png">
                    <img class="bl fiducial" src="fiducials/cs.jpg">
                    <img class="br fiducial" src="fiducials/change.jpg">
                    <h2 class="heading"></h1>
                    <div class="formFields"></div>
                </div>
            </div>
            
            <div class="panel">
                <button onclick="handleSave();" id="save">Save</button>
                <p>Output:</p>
                <textarea id="out"></textarea>
            </div>

        </div>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/jquery.qrcode.min.js"></script>
        <script src="assets/js/handlebars.js"></script>
        <script type="text/javascript" src="assets/js/html2canvas/build/html2canvas.js"></script>
        
        <script src="XLSXConverter/js-xlsx/jszip.js"></script>
        <script src="XLSXConverter/js-xlsx/xlsx.js"></script>
        <script src="XLSXConverter/underscore.js"></script>
        <script src="XLSXConverter/XLSXConverter.js"></script>
        
<script>

/*
XLS file is converted to json with some basic processing to nest
groups and parse type parameters.
The JSON is fed into a handlebars template that generates the HTML.
A number of helpers are defined to help render certain items.
After the HTML is rendered, jQuery is used to construct the formdef json from it.
*/
$(document).ready(function () {

function removeEmptyStrings(rObjArr){
    var outArr = [];
    _.each(rObjArr, function(row){
        var outRow = Object.create(row.__proto__);
        _.each(row, function(value, key){
            if(_.isString(value) && value.trim() === "") {
                return;
            }
            outRow[key] = value;
        });
        if(_.keys(outRow).length > 0) {
            outArr.push(outRow);
        }
    });
    return outArr;
}

function to_json(workbook) {
	var result = {};
	_.each(workbook.SheetNames, function(sheetName) {
		var rObjArr = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
        rObjArr = removeEmptyStrings(rObjArr);
		if(rObjArr.length > 0){
			result[sheetName] =  rObjArr;
		}
	});
	return result;
}

function print_output(output) {
    $('#out').text(output);
    $('#out').trigger("input");
}

function handleSave(e) {
    var uriContent = "data:application/octet-stream," + encodeURIComponent(document.getElementById("out").value);
    var downloader = document.createElement("iframe");
    downloader.style.display = "none";
    downloader.src = uriContent;
    document.body.appendChild(downloader);
}

var drop = document.getElementById('drop');
//TODO: Test multiple forms
function handleDrop(e) {
	e.stopPropagation();
	e.preventDefault();
	var files = e.dataTransfer.files;
	var f = files[0];

	var reader = new FileReader();
	var name = f.name;
    
    //Clear the warnings and errors:
    var errorsEl = document.getElementById('errors');
    while (errorsEl.hasChildNodes()) {
        errorsEl.removeChild(errorsEl.lastChild);
    }
    var warnings = document.getElementById('warnings');
    while (warnings.hasChildNodes()) {
        warnings.removeChild(warnings.lastChild);
    }

    reader.onload = function(e) {
		var data = e.target.result;
        var errorEl = document.createElement("p");
        if(f.name.slice(-3) === "xls"){
            errorEl.innerHTML = "Sorry, XLS files are not supported.<br />";
            errorEl.innerHTML += "You can convert your XLS file to XLSX using libreOffice or Google Docs.";
            errorsEl.appendChild(errorEl);
        } else {
             try {
                var xlsx = XLSX.read(data, {type: 'binary'});
                var jsonWorkbook = to_json(xlsx);
                //console.log(jsonWorkbook);
                var processedWorkbook = XLSXConverter.processJSONWorkbook(jsonWorkbook);
                
                renderForm(processedWorkbook);
                
                print_output(JSON.stringify(processedWorkbook, 2, 2));
                _.each(XLSXConverter.getWarnings(), function(warning){
                    var warningEl = document.createElement("p");
                    warningEl.innerHTML = warning;
                    console.log(warning);
                    warnings.appendChild(warningEl);
                });
            } catch(e) {
                errorEl.innerHTML = String(e);
                errorsEl.appendChild(errorEl);
                throw e;
            }
        }
	};
    try {
	    reader.readAsBinaryString(f);
    } catch(e) {
        errorEl.innerHTML = "Could not read file.";
        throw e;
    }
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}
drop.addEventListener('dragover', handleDragover, false);
drop.addEventListener('drop', handleDrop, false);


// compile and register the "element" partial template
//var formTemplate = Handlebars.compile($("#form-template").html());
var fieldRowTemplate = Handlebars.compile($("#field-row-template").html());
Handlebars.registerPartial("fieldRow", fieldRowTemplate);

var fieldColumnTemplate = Handlebars.compile($("#field-column-template").html());
Handlebars.registerPartial("fieldColumn", fieldColumnTemplate);

var segmentsTemplate = Handlebars.compile($("#segments-template").html());
Handlebars.registerPartial("segments", segmentsTemplate);


var typeAliases = {
    "text" : "string",
    "select_one" : "select1",
    "select_mulitple" : "select"
};

var renderForm = function(formJSON){
    console.log("Rendering...", formJSON);
    
    var attachItems = function(fields) {
        _.each(fields, function(field) {
            if('prompts' in field){
                attachItems(field.prompts);
                return;
            }
            field.type = field.type.toLowerCase();
            
            //Map from XLSForm types to internal type names that are closer
            //to XForm types.
            if(field.type in typeAliases) {
                field.type = typeAliases[field.type];
            } 
            
            if(field.type.match(/string|int/)){
                field.segments = [{}];
            }
            if(field.type.match(/select/)){
                field.segments = [{ items : formJSON.choices[field.param] }];
            }
            if(field.type.match(/tally/)){
                field.segments = [{ items :  _.map(_.range(parseInt(field.param, 10)), function(rIdx){
                        return { value: rIdx };
                    })
                }];
                console.log(field);
            }
            if(field.type.match(/bub_num/)){
                field.segments = _.map(_.range(parseInt(field.param, 10)), function(){
                    return { };
                });
                _.each(field.segments, function(segment){
                    segment.items = _.map(_.range(0, 10), function(rIdx){
                        return { value: rIdx, label: "" + rIdx, class: "vertical"};
                    });
                });
            }
            if(field.type.match(/bub_word/)){
                field.segments = _.map(_.range(parseInt(field.param, 10)), function(){
                    return { };
                });
                _.each(field.segments, function(segment){
                    var alphabet = ('abcdefghijklmnopqrstuvwxyz').split('');
                    segment.items = _.map(alphabet, function(letter){
                        return { value: letter, label: letter, class: "vertical" };
                    });
                });
            }
        });
    };
    
    var generateFormDef = function(){
        //This object will be the Scan formDef that we output:
        var formDef = {
            height: 1176,
            width: 832,
            classifier : {
                "classification_map": {
                     "empty": false
                },
                "default_classification": true,
                "training_data_uri": "bubbles",
                "classifier_height": 14,
                "classifier_width": 12,
                "advanced": {
                     "flip_training_data": true
                }
            }
        };
    
        //Set some of the dimensions using the default values in the formDef:
        $(".formImage").height(formDef.height);
        $(".formImage").width(formDef.width);
        $(".bubble").height(formDef.classifier.classifier_height * .7);
        $(".bubble").width(formDef.classifier.classifier_width  * .7);
        $(".heading").text(_.where(formJSON.settings, {setting: "form_title"})[0].value);
    
        //Generate the form image from the html.
        html2canvas( [ $(".formImage").get(0) ], {
          onrendered: function(canvas) {
            $('.outImg').attr('src', canvas.toDataURL('image/jpeg'));
          }
        });
        
        //Generate the formDef json using the HTML.
        var baseOffset = $(".fContainer").offset();
        formDef.fields = $(".fContainer").find('.scanField').map(function(idx, fieldEl){
            var $field = $(fieldEl);
            
            var segments = $field.find('.segment').map(function(idx, segmentEl){
                var $segment = $(segmentEl);
                var segAbsOffset = $segment.offset();
                var segOffset = {
                    top: segAbsOffset.top - baseOffset.top,
                        //(parseInt($segment.css("border-top-width"), 10)  / 2),
                    left: segAbsOffset.left - baseOffset.left
                        //(parseInt($segment.css("border-left-width"), 10) / 2)
                };
                var items = $segment.find('.bubble').map(function(idx, itemEl){
                    var $item = $(itemEl);
                    var itemAbsOffset = $item.offset();
                    var itemOffset = {
                        top: itemAbsOffset.top - segAbsOffset.top + ($item.innerHeight() + $item.outerHeight()) / 4,
                        left: itemAbsOffset.left - segAbsOffset.left + ($item.innerWidth() + $item.outerWidth()) / 4,
                    };
                    return {
                        //In theory this should remove any html markup.
                        label: $item.children('label').text(),
                        value: $item.data('value'),
                        item_x: itemOffset.left,
                        item_y: itemOffset.top
                    };
                }).toArray();
                var segment = {
                    segment_x: segOffset.left,
                    segment_y: segOffset.top,
                    segment_width: ($segment.innerWidth() + $segment.outerWidth()) / 2,
                    segment_height: ($segment.innerHeight() + $segment.outerHeight()) / 2
                };
                if(items.length > 0) {
                    segment.items = items;
                }
                return segment;
            }).toArray();
            var out = {
                name: $field.data('name'),
                type: "text",//TODO
                label: $field.find('label').first().text()
            };
            if(segments.length > 0) {
                out.segments = segments;
            }
            return out;
        }).toArray();
        console.log(JSON.stringify(formDef));
    };

    attachItems(formJSON.survey);
    console.log(formJSON);
    
    //Generate the form image as HTML.
    $(".formFields").html(fieldColumnTemplate({
        prompts: formJSON.survey
    }));
    
    //Generate the image and json
    generateFormDef();
    
    //Fiducal replacement functionality
    $(".fContainer").find('img').on('dragover', function(e){
        e.stopPropagation();
    	e.preventDefault();
    	e.originalEvent.dataTransfer.dropEffect = 'copy';
    });
    
    $(".fContainer").find('img').on('drop', function(e){
        e.stopPropagation();
        e.preventDefault();
    	var files = e.originalEvent.dataTransfer.files;
    	var f = files[0];
    
    	var reader = new FileReader();
    	var name = f.name;
        
        var $targetEl = $(e.target);
    
        reader.onload = function(e) {
    		$targetEl.attr('src', e.target.result);
            generateFormDef();
    	};
        reader.readAsDataURL(f);
    });
};
   
$.getJSON('test.json', renderForm);
   
});

</script>

<script id="field-row-template" type="text/x-handlebars-template">
    <table class="fieldRowTable"><tbody><tr class="fieldRow">
    {{#each prompts}}
        <td class="field {{#unless prompts}}scanField{{/unless}}" data-name="{{name}}">
        
        {{#if label}}<label>{{{label}}}</label>{{/if}}
        
        {{#if prompts}}
            {{> fieldColumn}}
        {{/if}}
        
        {{#if segments}}
            {{> segments}}
        {{/if}}
        
        </td>
    {{/each}}
    </tr></tbody></table>
</script>

<script id="field-column-template" type="text/x-handlebars-template">
    <div class="fieldColumn">
    {{#each prompts}}
        <div class="field {{#unless prompts}}scanField{{/unless}}" data-name="{{name}}">
        
        {{#if label}}<label>{{{label}}}</label>{{/if}}
        
        {{#if prompts}}
            {{> fieldRow}}
        {{/if}}
        
        {{#if segments}}
            {{> segments}}
        {{/if}}
        
        </div>
    {{/each}}
    </div>
</script>

<script id="segments-template" type="text/x-handlebars-template">
    <table class="segments"><tbody><tr>
    {{#each segments}}
        <td class="segment">
        {{#each items}}
            <span class="item {{class}}" data-value="{{value}}">
                {{#if label}}
                    <label>{{{label}}}</label>
                {{/if}}
                <span class="bubble"></span>
            </span>
        {{/each}}
        </td>
    {{/each}}
    </tr></tbody></table>
</script>

    </body>
</html>
